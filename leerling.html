<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leerlingoverzicht</title>

  <link rel="manifest" href="/opvolging_huistaken/manifest.json">
  <link rel="apple-touch-icon" href="/opvolging_huistaken/icon-192x192.png">
  <meta name="theme-color" content="#4A90E2">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .navigatie-container {
      position: absolute;
      top: 1rem;
      left: 1rem;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      padding-top: 4rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f9f9f9;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }
    h1 {
      margin: 0.5rem 0;
    }
    canvas {
      max-width: 400px;
      max-height: 400px;
      background-color: #fff;
    }
    .grafiek-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-grow: 1;
      justify-content: center;
      text-align: center;
    }
    #samenvatting {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-width: 300px;
      text-align: left;
    }
    #samenvatting h3 {
      margin-top: 0;
    }
    #samenvatting ul {
        padding-left: 20px;
    }
    #samenvatting ul ul {
        padding-left: 20px;
        font-style: italic;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .navigatie-container button {
      margin: 0;
    }

    .actie-knoppen {
        display: flex;
        gap: 10px;
    }

    @media print {
      .no-print {
        display: none !important;
      }
      canvas {
        background-color: transparent;
      }
    }
  </style>
</head>
<body>
  <div class="navigatie-container no-print">
    <button onclick="gaTerug()">← Terug naar overzicht</button>
  </div>

  <h1 id="titel"></h1>
  <div class="grafiek-container">
    <canvas id="taart"></canvas>
    <div id="samenvatting"></div>
    <div class="actie-knoppen no-print">
        <button id="kopieerBtn" onclick="kopieerSamenvatting()">Kopieer tekst</button>
        <button onclick="slaDiagramOp()">Sla diagram op</button>
        <button onclick="window.print()">Afdrukken</button>
    </div>
  </div>

  <script>
    function gaTerug() {
      window.location.href = 'dashboard.html';
    }

    async function kopieerSamenvatting() {
      const kopieerBtn = document.getElementById('kopieerBtn');
      const origineleTekst = kopieerBtn.textContent;
      
      let tekstVoorKlembord = `Samenvatting voor ${naam}:\n\n`;
      tekstVoorKlembord += `Op tijd: ${telling['op tijd']} keer\n`;

      for (const [status, datumLijst] of Object.entries(statusDetails)) {
          if (datumLijst.length > 0) {
              const statusNaam = status.charAt(0).toUpperCase() + status.slice(1);
              tekstVoorKlembord += `${statusNaam}: ${datumLijst.length} keer\n`;
              datumLijst.forEach(d => {
                  tekstVoorKlembord += `\t- ${d}\n`;
              });
          }
      }

      try {
        await navigator.clipboard.writeText(tekstVoorKlembord);
        kopieerBtn.textContent = 'Gekopieerd!';
      } catch (err) {
        kopieerBtn.textContent = 'Kopiëren mislukt';
        console.error('Fout bij kopiëren: ', err);
      }

      setTimeout(() => {
        kopieerBtn.textContent = origineleTekst;
      }, 2000);
    }

    function slaDiagramOp() {
        const canvas = document.getElementById('taart');
        const link = document.createElement('a');
        
        link.download = `diagram-${naam.replace(/ /g, '_')}.png`; 
        
        link.href = canvas.toDataURL('image/png');
        
        link.click();
    }

    const kleuren = {
      "op tijd": "#c8f7c5",
      "te laat": "#ffe0b3",
      "onvolledig": "#fff9c4",
      "niet gemaakt": "#f8d7da",
      "ziek": "#d0e7ff"
    };

    const query = new URLSearchParams(window.location.search);
    const naam = query.get("naam");
    document.getElementById("titel").textContent = `Overzicht voor ${naam}`;

    const alleData = JSON.parse(localStorage.getItem("detailPaginaData")) || {};
    const leerlingData = alleData[naam] || {};
    const statussen = (leerlingData.statussen || []).filter(s => s !== 'geen');
    const datums = leerlingData.datums || [];

    const telling = {"op tijd": 0, "te laat": 0, "onvolledig": 0, "niet gemaakt": 0, "ziek": 0};
    statussen.forEach(status => {
      if (status && telling[status] !== undefined) telling[status]++;
    });
    const totaal = Object.values(telling).reduce((a, b) => a + b, 0);

    const ctx = document.getElementById("taart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(telling).map(key => {
          const waarde = telling[key];
          const percentage = totaal > 0 ? Math.round((waarde / totaal) * 100) : 0;
          return `${key} (${percentage}%)`;
        }),
        datasets: [{
          data: Object.values(telling),
          backgroundColor: Object.keys(telling).map(k => kleuren[k])
        }]
      },
      options: { 
          responsive: true, 
          plugins: { 
              legend: { position: "bottom" } 
          },
          animation: {
              onComplete: () => {
                  ctx.globalCompositeOperation = 'destination-over';
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                  ctx.globalCompositeOperation = 'source-over';
              }
          }
      }
    });

    const samenvattingDiv = document.getElementById("samenvatting");
    let samenvattingHTML = "<h3>Samenvatting</h3><ul>";

    const statusDetails = {
      "te laat": [],
      "onvolledig": [],
      "niet gemaakt": [],
      "ziek": []
    };
    
    (leerlingData.statussen || []).forEach((status, index) => {
        if (statusDetails[status]) {
            const datumString = datums[index];
            if (datumString) {
                const [year, month, day] = datumString.split('-');
                statusDetails[status].push(`${day}/${month}/${year}`);
            } else {
                 statusDetails[status].push(`(geen datum)`);
            }
        }
    });

    samenvattingHTML += `<li><strong>Op tijd:</strong> ${telling['op tijd']} keer</li>`;

    for (const [status, datumLijst] of Object.entries(statusDetails)) {
        if (datumLijst.length > 0) {
            const statusNaam = status.charAt(0).toUpperCase() + status.slice(1);
            samenvattingHTML += `<li><strong>${statusNaam}:</strong> ${datumLijst.length} keer`;
            samenvattingHTML += `<ul>`;
            datumLijst.forEach(d => {
                samenvattingHTML += `<li>${d}</li>`;
            });
            samenvattingHTML += `</ul></li>`;
        }
    }

    samenvattingHTML += "</ul>";
    samenvattingDiv.innerHTML = samenvattingHTML;

  </script>
</body>
</html>