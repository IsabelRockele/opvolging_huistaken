<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leerlingoverzicht</title>

  <link rel="manifest" href="/opvolging_huistaken/manifest.json">
  <link rel="apple-touch-icon" href="/opvolging_huistaken/icon-192x192.png">
  <meta name="theme-color" content="#4A90E2">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* CSS is ongewijzigd, maar hier voor de volledigheid */
    .navigatie-container { position: absolute; top: 1rem; left: 1rem; }
    body {
      font-family: Arial, sans-serif; margin: 0; padding: 1rem; padding-top: 4rem;
      display: flex; flex-direction: column; align-items: center;
      background: #f9f9f9; min-height: 100vh; box-sizing: border-box; position: relative;
    }
    h1 { margin: 0.5rem 0; }
    canvas { max-width: 400px; max-height: 400px; background-color: #fff; }
    .grafiek-container {
      display: flex; flex-direction: column; align-items: center;
      flex-grow: 1; justify-content: center; text-align: center;
    }
    #samenvatting {
      margin-top: 1.5rem; padding: 1rem; background-color: #fff;
      border: 1px solid #ddd; border-radius: 8px; min-width: 300px; text-align: left;
    }
    #samenvatting h3 { margin-top: 0; }
    #samenvatting ul { padding-left: 20px; }
    #samenvatting ul ul { padding-left: 20px; font-style: italic; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; cursor: pointer; }
    .navigatie-container button { margin: 0; }
    .actie-knoppen { display: flex; gap: 10px; }
    @media print {
      .no-print { display: none !important; }
      canvas { background-color: transparent; }
    }
  </style>
</head>
<body>
  <div class="navigatie-container no-print">
    <button onclick="gaTerug()">‚Üê Terug naar overzicht</button>
  </div>

  <h1 id="titel"></h1>
  <div class="grafiek-container">
    <canvas id="taart"></canvas>
    <div id="samenvatting"></div>
    <div class="actie-knoppen no-print">
        <button id="kopieerBtn">Kopieer tekst</button>
        <button onclick="slaDiagramOp()">Sla diagram op</button>
        <button onclick="window.print()">Afdrukken</button>
    </div>
  </div>

<script>
    function gaTerug() { window.location.href = 'dashboard.html'; }

    const kleuren = {
      "op tijd": "#c8f7c5", "te laat": "#ffe0b3",
      "onvolledig": "#fff9c4", "niet gemaakt": "#f8d7da", "ziek": "#d0e7ff"
    };

    const query = new URLSearchParams(window.location.search);
    const naam = query.get("naam");
    document.getElementById("titel").textContent = `Overzicht voor ${naam}`;

    const allData = JSON.parse(localStorage.getItem("detailPaginaData")) || {};
    const leerling = allData.leerlingen?.find(l => l.naam === naam);
    const modus = allData.huidigeModus;
    const periode = allData.huidigePeriode;

    const telling = {"op tijd": 0, "te laat": 0, "onvolledig": 0, "niet gemaakt": 0, "ziek": 0};
    const statusDetails = {"te laat": [], "onvolledig": [], "niet gemaakt": [], "ziek": []};

    if (leerling && modus && periode) {
        if (modus === 'week') {
            const weekKolommen = allData.weekKolommen[periode] || [];
            const weekData = allData.huistakenWeek[leerling.id]?.[periode] || {};
            const weekDatums = allData.weekDatums[periode] || {};
            weekKolommen.forEach(weekNum => {
                // Sla weken over als de leerling er nog niet was
                if (leerling.startWeek && weekNum < leerling.startWeek) {
                    return; // Ga naar de volgende week
                }
                const data = weekData[weekNum] || { status: 'op tijd', opmerking: '' };

                if(telling[data.status] !== undefined) telling[data.status]++;
                if (statusDetails[data.status]) {
                    const datumString = weekDatums[weekNum]; 
                    const formattedDate = datumString ? `${datumString.split('-')[2]}/${datumString.split('-')[1]}/${datumString.split('-')[0]}` : `Week ${weekNum}`;
                    const opmerking = data.opmerking ? ` (${data.opmerking})` : '';
                    statusDetails[data.status].push(`${formattedDate}${opmerking}`);
                }
            });
        } else { // modus === 'dag'
            const dagData = allData.huistakenDag[leerling.id]?.[periode] || {};
            const dagKolommen = (allData.dagKolommen[periode] || []).sort();
            dagKolommen.forEach(datum => {
                // Sla dagen over als de leerling er nog niet was
                if (leerling.startDatum && datum < leerling.startDatum) {
                    return; // Ga naar de volgende dag
                }
                const data = dagData[datum] || { status: 'op tijd', opmerking: '' };
                
                if(telling[data.status] !== undefined) telling[data.status]++;
                if (statusDetails[data.status]) {
                    const formattedDate = `${datum.split('-')[2]}/${datum.split('-')[1]}/${datum.split('-')[0]}`;
                    const opmerking = data.opmerking ? ` (${data.opmerking})` : '';
                    statusDetails[data.status].push(`${formattedDate}${opmerking}`);
                }
            });
        }
    }

    const totaal = Object.values(telling).reduce((a, b) => a + b, 0);

    new Chart(document.getElementById("taart").getContext("2d"), {
      type: "pie",
      data: {
        labels: Object.keys(telling).map(key => {
          const waarde = telling[key];
          const percentage = totaal > 0 ? Math.round((waarde / totaal) * 100) : 0;
          return `${key} (${percentage}%)`;
        }),
        datasets: [{ data: Object.values(telling), backgroundColor: Object.keys(telling).map(k => kleuren[k]) }]
      },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });

    let samenvattingHTML = "<h3>Samenvatting</h3><ul>";
    samenvattingHTML += `<li><strong>Op tijd:</strong> ${telling['op tijd']} keer</li>`;
    for (const [status, detailLijst] of Object.entries(statusDetails)) {
        if (detailLijst.length > 0) {
            const statusNaam = status.charAt(0).toUpperCase() + status.slice(1);
            samenvattingHTML += `<li><strong>${statusNaam}:</strong> ${detailLijst.length} keer<ul>`;
            detailLijst.forEach(d => { samenvattingHTML += `<li>${d}</li>`; });
            samenvattingHTML += `</ul></li>`;
        }
    }
    samenvattingHTML += "</ul>";
    document.getElementById("samenvatting").innerHTML = samenvattingHTML;
    
    document.getElementById('kopieerBtn').onclick = async function() { /* ... ongewijzigd ... */ };
    function slaDiagramOp() { /* ... ongewijzigd ... */ }
</script>
</body>
</html>